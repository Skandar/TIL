# Приоритет загрузки JavaScript в Chrome

В зависимости от того где и каким образом загружается JS, скрипты могут иметь разный приоритет загрузки и исполнения.

|                                                              | **Приоритет загрузки** <br />(сеть/Blink) | **Приоритет исполнения**                                     | **Применение**                                               |
| ------------------------------------------------------------ | ----------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `<script>` в `<head>`                                        | Средний / высокий                         | Очень высокий (блокирует парсер)                             | - Скрипты влияющие на интерфейс ([First Meaningful Paint](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics#first_meaningful_paint_and_hero_element_timing)(FMP) / [First Contentful Paint](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics#first_paint_and_first_contentful_paint) (FCP)) <br /> - Скрипты которые должны быть выполнены первыми<br /> <br />**Примеры:**<br /> - Framework runtime (при [не статическом рендеринге](https://developers.google.com/web/updates/2019/02/rendering-on-the-web)).<br />- Полифилы.<br />- A/B тестирование, которое влияет на DOM структуру всей страницы. |
| `<link rel=preload>`+ `<script async>` хак или `<script type=module async>` | Средний / высокий                         | Высокий (прерывает работу парсера)                           | - Скрипты генерирующие критический контент (необходимый для FMP), но не влияющие на первый экран<br />- Скрипты запускающие загрузку динамически добавляемого контента<br />- Скрипты которые необходимо выполнить как только их импорты загрузились `<script async type=module>`<br /><br />**Пример:** <br />- Рисование на`<canvas>` |
| `<script async>`                                             | Низший/низкий                             | Высокий (прерывает работу парсера)                           | Быть [осторожным](https://calendar.perfplanet.com/2016/prefer-defer-over-async/) при использовании `<script async>`, из-за непоследовательной загрузке/исполнению скриптов, и из-за того что загружается с низким приоритетом, а исполняется с высоким. |
| `<script defer>`                                             | Низший/низкий                             | Очень низкий- выполняется после `<script>` в конце `<body>`  | Скрипты генерирующие не критический контент<br />Скрипты, которые предоставляют ключевые интерактивные функции, которыми будут использоваться в большей половине посещений пользователей<br /><br /> **Примеры:**<br />- Реклама<br />- Framework runtime (в случае рендеринга на стороне [клиента](https://developers.google.com/web/updates/2019/02/rendering-on-the-web#csr) или [сервера](https://developers.google.com/web/updates/2019/02/rendering-on-the-web#server-rendering)) |
| `<script>` в конце `<body>`                                  | Средний/высокий                           | Низкий - ждёт окончания работы парсера                       | Быть осторожным при использовании `<script>` в конце `<body>`. Предполагается, что он должен иметь низкий приоритет (т.к. в самом конце), но по факту имеет средний/высокий приоритет. |
| `<script defer>` в конце `<body>`                            | Низший/низкий - конец очереди             | Очень низкий - исполняетсяс после`<script>` в конце `<body>` | Скрипты которые, которые предоставляют интерактивные функции, которые могут быть использованы случайно<br /><br />**Примеры:**<br />- Загрузить "Похожие статьи"<br />- "Оставить отзыв" |
| `<link rel=prefetch>`+ `<script>` при межстраничной навигации | Ожидание/ низший                          | Зависит от того где и когда скрипт будет загружен            | Скрипты, вероятно, предоставляющие важную информацию для перехода на следующую страницу.<br /><br />**Пример:**<br />- JS бандл для будущего роутинга |



## Особенности атрибутов `async` и `prefer`

- Загружаются асинхронно (не блокируют HTML парсер).

- Скрипт с атрибутом `async` может блокировать рендеринг и синхронный JS, который объявлен раньше (в случае если скрипт с атрибутом `async` загрузится раньше него).

- Скрипт загруженный с атрибутом `async` исполняется сразу после загрузки, а скрипт с атрибутом `prefer` исполняется только после того как HTML парсер закончит свою работу.

- Скрипты с атрибутом `async` загружаются не последовательно, `prefer` последовательно (в   IE<=9  есть [баг](https://github.com/h5bp/lazyweb-requests/issues/42), который делает загрузку не последовательной).

  

## Ссылки

- [JavaScript Loading Priorities in Chrome](https://addyosmani.com/blog/script-priorities/)
- [Prefer DEFER Over ASYNC](https://calendar.perfplanet.com/2016/prefer-defer-over-async/)
