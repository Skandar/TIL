# Куки

Позволяют запоминать состояние для HTTP, который сам не умеет этого делать.

## Применение

- Управление сессиями (логины, корзины магазинов).
- Персонализация (темы и пользовательские предпочтения).
- Трекинг (запись и анализ поведения пользователя).

## Жизненный цикл куков

Куки обычно создаются на сервере с помощью добавление к ответу сервера заголовка `Set-Cookie`:

```http
HTTP/2.0 200 OK
Content-Type: text/html
Set-Cookie: new_cookie=cookie_value
Set-Cookie: new_cookie_2=cookie_value_2

[page content]
```

И посылаются на сервер в каждом запросе к серверу:

```http
GET /sample_page.html HTTP/2.0
Host: www.example.org
Cookie: new_cookie=cookie_value; new_cookie_2=cookie_value_2
```

Удаляются куки таким образом:

- Браузер удаляет куку после того как она просрочена.

  ```http
  Set-Cookie: id=a3fWa; Expires=Wed, 31 Oct 2021 07:28:00 GMT;
  ```

- Для целенаправленного удаления куки в ответе для `Expires` назначается уже прошедшая дата.

  ```http
  Set-Cookie: id=a3fWa; Expires=Wed, 01 Jan 1970 00:00:00 GMT;
  ```

## Ограничение доступа к кукам

Для безопасного использования куков есть несколько атрибутов:

- `Secure` - кука будут отдаваться только через HTTPS. Помогает от session hijacking атак.
- `HttpOnly` - кука будет не доступна для JS. Уменьшает шанс пострадать от XSS атак.

## Куда отсылать куки?

- `Domain` - если атрибут не установлен, то кука отсылается на тот же источника (origin) с которого кука была назначена, не включая поддомены. Если атрибут указан, то включая поддомены. Этот атрибут удобен в случае когда необходимо, чтобы поддомены знали о куках.

  ```http
  Set-Cookies: key=value; Domain=example.org
  ```

- `Path` - определяет путь который должен быть в URL к которому выполняется запрос. Например, указывая `Path=/ru` кука будет отправляться на URL содержащий `/ru`, `/ru/shop/`, `/ru/shop/sale/`.

  ```http
    Set-Cookies: key=value; Path=/ru
  ```

- `SameSite` - определяет возможность отправления cross-origin запросов.
  - `Strict` -  запрещены все cross-origin запросы.
  - `Lax` - кука будет добавлена в случае top-level навигации (переход по ссылке).  Начиная с Chrome 84 значение по умолчанию, в Firefox 69 за флагом.
  - `None` - нет ограничений. Начиная с Chrome 84 при указании этого значения добавляется `Secure`.

`SameSite` атрибут предоставляет некую защиту от CSRF (Cross-Site Request Forgery) атак.

## Префиксы

Префиксы позволяют определить, что кука была действительно добавлена из безопасного источника.

- `__Host-` - работает только в том случае если у куки так же добавлен `Secure`, `Path=/` запрос был отправлен из безопасного источника и нет атрибута `Domain`.

  ```http
  Set-Cookie: __Host-ID=123; Secure; Path=/
  ```

- `__Secure-` - работает только в том случае если у куки так же добавлен `Secure` и запрос был отправлен из безопасного источника.

  ```http
  Set-Cookie: __Secure-ID=123; Secure; Domain=example.com
  ```

В случае если кука с префиксом не удовлетворяет какому-то параметру, она игнорируется браузером.

## Ссылки

- [MDN. Using HTTP cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)
- [web.dev. SameSite cookies explained](https://web.dev/samesite-cookies-explained/)
